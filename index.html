<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Informe Interactivo - Reporte</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f4f7fa;
      color: #333;
    }
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 250px;
      background-color: #1f77b4;
      padding-top: 20px;
      transition: all 0.3s;
      z-index: 1000;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    .sidebar a {
      color: white;
      padding: 10px 20px;
      display: block;
      text-decoration: none;
      transition: background-color 0.2s;
    }
    .sidebar a:hover {
      background-color: #aec7e8;
      color: #1f77b4;
    }
    .sidebar h3 {
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      padding-bottom: 15px;
      margin-bottom: 20px;
    }
    .content {
      margin-left: 270px;
      padding: 20px;
    }
    .card {
      border: none;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .card-header {
      background-color: #1f77b4;
      color: white;
      border-radius: 10px 10px 0 0;
      padding: 15px 20px;
      font-size: 1.25rem;
      font-weight: bold;
    }
    .task-card {
      margin-bottom: 10px;
      border: 1px solid #e0e0e0;
      transition: transform 0.2s;
    }
    .task-card:hover {
      transform: translateY(-3px);
    }
    .progress {
      height: 20px;
      border-radius: 10px;
      background-color: #e9ecef;
    }
    .plot-container {
      width: 100%;
      height: 500px;
      margin-bottom: 30px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
    }
    .filter-container {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #e9f0f6;
      border-radius: 8px;
      border: 1px solid #d0e0f0;
    }
    .filter-container label {
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
      color: #1f77b4;
    }
    .no-results {
      color: #7f7f7f;
      text-align: center;
      margin-top: 20px;
      padding: 20px;
      border: 1px dashed #ccc;
      border-radius: 8px;
      background-color: #fff;
    }
    .loading {
      text-align: center;
      color: #1f77b4;
      margin: 20px 0;
      font-size: 1.2em;
      font-weight: bold;
    }
    .date-status {
      display: inline-block;
      margin-left: 10px;
      font-size: 0.85em;
      padding: 3px 8px;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .date-status.green { background-color: #28a745; }
    .date-status.orange { background-color: #ffc107; color: #333; }
    .date-status.red { background-color: #dc3545; }
    .toggle-details {
      cursor: pointer;
      color: #1f77b4;
      font-weight: bold;
    }
    .toggle-details:hover {
      text-decoration: underline !important;
    }
    .toggle-details i {
      transition: transform 0.2s;
    }
    .toggle-details[aria-expanded="true"] i {
      transform: rotate(180deg);
    }
    .details-content {
      border-top: 1px dashed #e9ecef;
      padding-top: 15px;
      margin-top: 15px;
    }
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
      .content {
        margin-left: 0;
      }
    }
    .progress-bar-full {
      background-color: #28a745 !important;
    }
    .btn-toggle-finalizados {
      background-color: hsl(187, 96%, 48%);
      color: white;
      border: none;
    }
    .btn-toggle-finalizados:hover {
      background-color: #0069d9;
    }
    .btn-toggle-finalizados.modo-activo {
      background-color: #f33210;
      color: #fff;
    }
    .bg-verde-finalizado {
      background-color: #28c76f !important;
      color: white;
    }
    #observaciones-input {
      resize: vertical;
      margin-bottom: 15px;
      border-radius: 8px;
      border: 1px solid #d0e0f0;
    }
    #saved-observations p {
      background-color: #e9f0f6;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid #1f77b4;
      font-size: 0.95em;
      word-break: break-word;
    }
    #saved-observations {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 10px;
    }
      #dashboard {
        margin-bottom: 30px;
    }

    .dashboard-container {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }

    .card-dashboard {
        background: #ffffff;
        padding: 20px;
        border-radius: 6px;
        width: 220px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .card-dashboard h4 {
        margin: 0;
        font-size: 14px;
        color: #555;
    }

    .card-dashboard h2 {
        margin-top: 10px;
        font-size: 26px;
        font-weight: bold;
    }
        
    .total { border-left: 5px solid #1f77b4; }
    .proximo { border-left: 5px solid #f0ad4e; }
    .alta { border-left: 5px solid #d9534f; }
    .vencido { border-left: 5px solid #c9302c; }
    .card.alta { background-color: #f30e0e; }
    .card.media { background-color: #fffdf3; }
    .card.baja { background-color: #f3fff6; }
    .dashboard-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.card {
    background: #ffffff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 14px rgba(0,0,0,0.12);
}

.card h4 {
    font-size: 14px;
    color: #666;
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.card h2 {
    font-size: 28px;
    font-weight: bold;
    margin: 0;
}
/* Esto hace que SOLO las tarjetas del dashboard se centren */
.dashboard-cards .card {
    text-align: center;
    cursor: pointer;
}

/* Esto asegura que las tareas se lean bien de izquierda a derecha */
.task-card {
    text-align: left !important;
}
/* TOTAL */
.card.total {
    border-left: 6px solid #3498db;
    background-color: #f4f9ff;
}

/* VENCIDOS */
.card.vencido {
    border-left: 6px solid #c0392b;
    background-color: #fff0f0;
}

/* PROXIMOS */
.card.proximo {
    border-left: 6px solid #f39c12;
    background-color: #fff8eb;
}
/* PRIORIDADES */
.card.alta {
    border-left: 6px solid #e74c3c;
    background-color: #fff5f5;
}

.card.media {
    border-left: 6px solid #f1c40f;
    background-color: #fffdf3;
}

.card.baja {
    border-left: 6px solid #2ecc71;
    background-color: #f3fff6;
}
/* 1. Mantiene los n√∫meros del dashboard centrados y elegantes */
.dashboard-cards .card {
    text-align: center !important;
    cursor: pointer;
}

/* 2. REGLA DE ORO: Fuerza a que las tareas se alineen a la izquierda */
.task-card {
    text-align: left !important;
}

/* 3. Asegura que el texto dentro de las tareas (t√≠tulos y p√°rrafos) no herede el centrado */
.task-card h5, 
.task-card p, 
.task-card div {
    text-align: left !important;
}

/* 4. Mejora visual: un efecto sutil al pasar el mouse por las tarjetas del dashboard */
.dashboard-cards .card:hover {
    filter: brightness(0.95);
    transform: scale(1.02);
}
/* Esto es lo que hace que la tarjeta brille y crezca */
.card-activa {
    border: 3px solid #1f77b4 !important;
    box-shadow: 0 0 20px rgba(31, 119, 180, 0.6) !important;
    transform: scale(1.05) !important;
    transition: all 0.3s ease !important;
}
/* El texto "(Clic para quitar)" */
.card-activa h4::after {
    content: " (Clic para quitar)";
    font-size: 11px;
    display: block;
    color: #1f77b4;
    font-weight: bold;
    margin-top: 5px;
}
 </style>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const fecha = new Date();
      const opciones = { day: '2-digit', month: '2-digit', year: 'numeric' };
      const fechaFormateada = fecha.toLocaleDateString('es-CO', opciones);
      const reportSpan = document.getElementById('reportDate');
      if (reportSpan) {
        reportSpan.textContent = fechaFormateada;
      }
    });
  </script>
</head>
<body>  
  <div class="container-fluid mt-4 px-4"></div>
  <nav class="sidebar">
    <h3 class="text-center text-white mb-4">Informe Requerimientos Imagine</h3>
    <a href="#resumen"><i class="fas fa-chart-pie me-2"></i>Resumen Ejecutivo</a>
    <a href="#tareas"><i class="fas fa-tasks me-2"></i>Tareas</a>
    <a href="#lastUpdateByUnitContainer">
  <i class="fas fa-clock me-2"></i>√öltima actualizaci√≥n por Unidad
</a>
    <a href="#estadisticas"><i class="fas fa-chart-bar me-2"></i>Estad√≠sticas</a>
    <a href="#graficos"><i class="fas fa-chart-line me-2"></i>Gr√°ficos</a>
    <!-- <a href="#recomendaciones"><i class="fas fa-lightbulb me-2"></i>Recomendaciones</a> -->
   <!--  <a href="#observaciones"><i class="fas fa-comment me-2"></i>Observaciones</a> -->
  </nav>

  <div class="content">
    <div id="dashboard">

    <h2>üìä Dashboard de Requerimientos</h2>

          <div class="dashboard-cards">

                <div class="card total" onclick="activarFiltroDashboard('total')">
            <h4>Total Requerimientos</h4>
            <h2 id="totalTasks">0</h2>
        </div>

        <div class="card vencido" onclick="activarFiltroDashboard('vencido')">
            <h4>Vencidos</h4>
            <h2 id="overdueTasks">0</h2>
        </div>

        <div class="card proximo" onclick="activarFiltroDashboard('proximo')">
            <h4>Pr√≥ximos a Vencer</h4>
            <h2 id="upcomingTasks">0</h2>
        </div>

        <div class="card alta" onclick="activarFiltroDashboard('alta')">
            <h4>Prioridad Alta</h4>
            <h2 id="highPriorityTasks">0</h2>
        </div>

        <div class="card media" onclick="activarFiltroDashboard('media')">
            <h4>Prioridad Media</h4>
            <h2 id="mediumPriorityTasks">0</h2>
        </div>

        <div class="card baja" onclick="activarFiltroDashboard('baja')">
            <h4>Prioridad Baja</h4>
            <h2 id="lowPriorityTasks">0</h2>
        </div>
      </div>


    <div class="tasks-container">

  </div>


</div>

        <!-- Encabezado del reporte -->
    <div style="
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    ">
      <h1 style="
        margin: 0;
        font-size: 1.8rem;
        font-weight: 600;
        color: #1a1a1a;
      ">Reporte - <span id="reportDate"></span>
      </h1>
      <img src="Imagenes/Logo_imagine.jpg" alt="Logo"
          style="
            height: 80px;
            object-fit: contain;
            margin-right: 10px;
            margin-top: 5px;
          ">
    </div>

    <div id="resumen" class="card">
      <div class="card-header">
        <h2>Resumen Ejecutivo</h2>
      </div>
      <div class="card-body" id="resumenContent">
        <p class="loading">Cargando resumen...</p>
      </div>
    </div>

    <div id="tareas" class="card">
      <div class="card-header">
        <h2>Tareas</h2>
      </div>
      <div class="card-body">
        <div class="filter-container">
          <div class="row g-3">
            <div class="row align-items-end">
  <div class="col-md-2">
    <label for="estadoFiltro">Filtrar por Estado:</label>
    <select id="estadoFiltro" class="form-control form-control-sm">
      <option value="Todos">Todos</option>
      <!-- m√°s opciones -->
    </select>
  </div>
  <div class="col-md-2">
    <label for="unidadFiltro">Filtrar por Unidad:</label>
    <select id="unidadFiltro" class="form-control form-control-sm">
      <option value="">Falta</option>
      <!-- m√°s opciones -->
    </select>
  </div>
  <div class="col-md-2">
    <label for="fechaInicioFiltro">Fecha Inicio Desde:</label>
    <input type="date" id="fechaInicioFiltro" class="form-control form-control-sm">
  </div>
  <div class="col-md-2">
    <label for="fechaFinFiltro">Fecha Fin Hasta:</label>
    <input type="date" id="fechaFinFiltro" class="form-control form-control-sm">
  </div>
  <div class="col-md-2">
  <label for="idFiltro">Filtrar por ID:</label>
  <input type="text" id="idFiltro" class="form-control form-control-sm" placeholder="ID Requerimiento">
</div>
  <div class="col-md-3">
    <label for="busqueda">Buscar por T√≠tulo o Persona:</label>
    <input type="text" id="busqueda" class="form-control form-control-sm" placeholder="T√≠tulo o Persona">
  </div>
  <div class="col-md-1">
    <label class="d-none d-md-block">&nbsp;</label>
    <button id="btnLimpiarFiltros" class="btn btn-secondary btn-sm">Limpiar</button>
  </div>
</div>

        <div class="d-flex justify-content-start mb-2">
          
          <button id="toggleFinalizados" class="btn btn-sm btn-toggle-finalizados">Mostrar Finalizados</button>
        </div>
        <div id="taskList">
          <p class="no-results">Cargando tareas...</p>
        </div>
      </div>
    </div>
    
    <div id="lastUpdateByUnit" class="card mt-3">
  <div class="card-header">
    <h2>√öltima actualizaci√≥n por Unidad</h2>
  </div>
  <div class="card-body">
    <div id="lastUpdateByUnitContainer"></div>
  </div>
</div>

    <div id="estadisticas" class="card">
      <div class="card-header">
        <h2>Resumen Estad√≠stico</h2>
      </div>
      <div class="card-body" id="estadisticasContent">
        <p class="loading">Cargando estad√≠sticas...</p>
      </div>
    </div>

    <div id="graficos" class="card">
      <div class="card-header">
        <h2>Gr√°ficos Interactivos</h2>
      </div>
      <div class="card-body">
        <!--<button class="btn btn-primary mb-3 me-2" onclick="exportToPDF()"><i class="fas fa-file-pdf me-2"></i>Exportar a PDF</button>
        <button class="btn btn-secondary mb-3" onclick="exportToPNG()"><i class="fas fa-image me-2"></i>Exportar Gr√°ficos a PNG</button>-->
        <div class="loading" id="loadingPie" style="display: none;">Cargando gr√°fico de distribuci√≥n...</div>
        <div id="pie-chart" class="plot-container"></div>
        <div class="loading" id="loadingBar" style="display: none;">Cargando gr√°fico de avance...</div>
        <div id="bar-chart" class="plot-container"></div>
        <div class="loading" id="loadingAssignments" style="display: none;">Cargando gr√°fico de asignaciones...</div>
        <div id="assignments-chart" class="plot-container"></div>
      </div>
    </div>

    <!-- <div id="recomendaciones" class="card">
      <div class="card-header">
        <h2>Recomendaciones</h2>
      </div>
      <div class="card-body">
        <p>Se recomienda priorizar las tareas en estado 'Pendiente' y revisar la efectividad de los procesos de Entrenamiento de IA. Preste atenci√≥n a las tareas con fecha de fin pr√≥xima o vencida para evitar retrasos.</p>
      </div>
    </div> -->

    <!-- <div id="observaciones" class="card">
  <div class="card-header">
    <h2>Observaciones</h2>
  </div>
  <div class="card-body"> -->
    <!-- Campo para el nombre -->
    <!-- <label for="nombre-observador" class="form-label">
  Tu nombre <span style="color: red">*</span>
</label> -->
<!-- <input
  id="nombre-observador"
  type="text"
  class="form-control mb-2"
  placeholder="Ej. Juan "
/> -->

    <!-- Campo para la observaci√≥n -->
    <!-- <textarea id="observaciones-input" class="form-control" placeholder="Escribe tus observaciones aqu√≠..." rows="4"></textarea> -->

    <!-- Bot√≥n -->
    <!-- <button class="btn btn-primary mt-3" onclick="submitObservation()">
      <i class="fas fa-save me-2"></i>Guardar Observaci√≥n
    </button> -->

    <!-- Observaciones guardadas -->
    <!-- <div id="saved-observations" class="mt-3">
      <p class="loading">Cargando observaciones...</p>
    </div>
  </div>
</div> -->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Fechas para el reporte
    const today = new Date('2025-06-16T17:30:23'); // Fecha fija como en el c√≥digo original
    // Alternativa: const today = new Date(); // Descomentar para usar fecha actual
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const year = today.getFullYear();
    const formattedDate = `${day}/${month}/${year}`;
    document.title = `Informe Interactivo - Reporte ${formattedDate}`;
    document.getElementById('reportDate').textContent = formattedDate;

    // Estructura de datos JSON
    let tasks = [];
    let filtroDashboard = null;
     function activarFiltroDashboard(tipo) {
    console.log("Intentando filtrar por:", tipo); // Esto nos dir√° si el clic funciona
    
    const todasLasTarjetas = document.querySelectorAll('.dashboard-cards .card');
    
    if (filtroDashboard === tipo) {
        filtroDashboard = null;
        todasLasTarjetas.forEach(t => t.classList.remove('card-activa'));
    } else {
        filtroDashboard = tipo;
        todasLasTarjetas.forEach(t => t.classList.remove('card-activa'));
        
        // Buscamos la tarjeta por su clase para ponerle el borde azul
        const tarjetaSeleccionada = document.querySelector('.dashboard-cards .card.' + tipo);
        if (tarjetaSeleccionada) {
            tarjetaSeleccionada.classList.add('card-activa');
        }
    }

    applyFilters(); // Llamamos al filtro maestro
}
    const archivos = [
      'datos/Bolivar.json',
      'datos/Proteccion.json',
      'datos/Alfa.json',
      'datos/Colmedica.json',
      'datos/Tuya.json',
      'datos/Colmena.json',
      'datos/Colpatria.json'
    ];
    console.log("Cargando archivos JSON:", archivos);
    Promise.all(archivos.map(url => fetch(url).then(r => {
      if (!r.ok) throw new Error(`No se pudo cargar ${url}`);
      return r.json();
    })))
      .then(respuestas => {
        tasks = respuestas.flat();
        if (tasks.length === 0) {
          document.getElementById('taskList').innerHTML = '<p class="no-results">No se encontraron tareas en los datos cargados.</p>';
          return;
        }
        initializeReport();
        applyFilters();
      })
      .catch(error => {
        console.error("Error al cargar los archivos JSON:", error);
        document.getElementById('taskList').innerHTML = `<p class="no-results">Error al cargar los datos: ${error.message}</p>`;
      });

        // Mapeo de estados a colores
        const stateColors = {
      "en proceso": "#1f77b4",        // Azul fuerte
      "Paso A Produccion": "#ff7f0e", // Naranja
      "Entrenamiento": "#2ca02c",     // Verde
      "en test": "#d62728",           // Rojo
      "pendiente": "#bcbd22",         // Verde lima
      "pendiente Cliente": "#e377c2",   // Fucsia
      "pausado": "#17becf",           // Turquesa
      "detenido Cliente": "#8c564b",    // Marr√≥n
      "finalizado": "#2ca58d",        // Verde azulado
      "pruebas imagine": "#9467bd",   // Morado
      "Pruebas Cliente": "#ff9896",     // Rosa claro
      "pruebas cacol": "#f7b6d2",     // Rosa pastel
    };


    // Funci√≥n para parsear fechas
    function parseDate(dateStr) {
  if (!dateStr || typeof dateStr !== 'string' || !dateStr.includes('/')) {
    return null;
  }

  const [day, month, year] = dateStr.split('/');
  if (!day || !month || !year) return null;

 // ‚ö†Ô∏è Forzar fecha en horario local (evita desfase UTC)
  return new Date(
    Number(year),
    Number(month) - 1,
    Number(day),
    12, 0, 0
  );
}

    // Funci√≥n para obtener el estado de la fecha de fin
    function getDateStatus(endDateString) {
      if (!endDateString || endDateString.toLowerCase() === 'n/a' || endDateString === '') return { text: 'Sin Fecha Fin', class: '' };
      const endDate = parseDate(endDateString);
      if (!endDate || isNaN(endDate.getTime())) return { text: 'Fecha Inv√°lida', class: '' };
      const now = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const end = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
      const diffTime = end.getTime() - now.getTime();
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      if (diffDays < 0) {
        return { text: 'Vencida', class: 'red' };
      } else if (diffDays <= 7 && diffDays >= 0) {
        return { text: `Vence en ${diffDays} d√≠a${diffDays !== 1 ? 's' : ''}`, class: 'orange' };
      } else {
        return { text: 'A tiempo', class: 'green' };
      }
    }

    // Funci√≥n para generar opciones del filtro de estado
    function populateEstadoFilter(availableTasks) {
      const estadoFiltro = document.getElementById('estadoFiltro');
      const currentSelectedValue = estadoFiltro.value;
      estadoFiltro.innerHTML = '<option value="">Todos</option>';
      const uniqueStates = [...new Set(availableTasks.map(task => task.state))].sort();
      uniqueStates.forEach(state => {
        const option = document.createElement('option');
        option.value = state;
        option.textContent = state;
        estadoFiltro.appendChild(option);
      });
      if (uniqueStates.includes(currentSelectedValue)) {
        estadoFiltro.value = currentSelectedValue;
      } else {
        estadoFiltro.value = '';
      }
    }
    function populateUnidadFilter(availableTasks) {
  const unidadFiltro = document.getElementById('unidadFiltro');
  const currentSelectedValue = unidadFiltro.value;
  
  unidadFiltro.innerHTML = '<option value="">Todos</option>';
  
  // CAMBIO: Usamos 'tasks' (la lista completa) en lugar de 'availableTasks'
  // As√≠ el men√∫ siempre tiene todas las opciones posibles
  const listaParaMenu = (typeof tasks !== 'undefined') ? tasks : availableTasks;

  const uniqueUnits = [...new Set(listaParaMenu.map(task => task.unit).filter(Boolean))].sort();
  
  uniqueUnits.forEach(unit => {
    const option = document.createElement('option');
    option.value = unit;
    option.textContent = unit;
    unidadFiltro.appendChild(option);
  });

  // Mantenemos la selecci√≥n que ten√≠a el usuario
  if (uniqueUnits.includes(currentSelectedValue)) {
    unidadFiltro.value = currentSelectedValue;
  } else {
    unidadFiltro.value = '';
  }
}
    // Renderizar Resumen Ejecutivo
    function updateSummary(filteredTasks = tasks) {
      filteredTasks = filteredTasks.filter(t => t.visible !== false);
      const resumenContent = document.getElementById('resumenContent');
      const totalTasks = filteredTasks.length;
      const inProgress = filteredTasks.filter(t => ["En Proceso", "Entrenamiento", "Pruebas Imagine", "Paso A Produccion", "En Test", "Estimar"].includes(t.state)).length;
      const pending = filteredTasks.filter(t => ["Pendiente", "Pausado", "Detenido Cliente", "Pruebas Cliente","Pendiente Cliente","Reanudar","Control De Cambios Produccion"].includes(t.state)).length;
      const completed = filteredTasks.filter(t => ["Finalizado","Cancelado"].includes(t.state)).length;
      const avgProgress = totalTasks > 0 ? filteredTasks.reduce((sum, t) => sum + t.progress, 0) / totalTasks : 0;
      resumenContent.innerHTML = `
        <p><strong>Total de Tareas:</strong> ${totalTasks}</p>
        <p><strong>En Proceso:</strong> ${inProgress} (${totalTasks > 0 ? ((inProgress / totalTasks) * 100).toFixed(1) : 0}%)</p>
        <p><strong>Pendientes:</strong> ${pending} (${totalTasks > 0 ? ((pending / totalTasks) * 100).toFixed(1) : 0}%)</p>
        <p><strong>Finalizadas:</strong> ${completed} (${totalTasks > 0 ? ((completed / totalTasks) * 100).toFixed(1) : 0}%)</p>
        <p><strong>Avance Promedio:</strong> ${avgProgress.toFixed(1)}%</p>
      `;
    }
        function updateDashboard(filteredTasks = tasks) {
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);

    let total = 0;
    let vencidos = 0;
    let proximos = 0;
    let prioridadAlta = 0;
    let prioridadMedia = 0;
    let prioridadBaja = 0;

    filteredTasks.forEach(task => {
        if (task.visible === false) return;

        total++;

        const fechaControl = task.fechaCompromisoCliente || task.fechaEstimadaEntrega;
        const fecha = parseDate(fechaControl);

        // Si la tarea ya est√° terminada, no la contamos en las categor√≠as de tiempo
        if (task.progress >= 100) return;

        // --- AQU√ç EST√Å EL CAMBIO ---
        if (!fecha) {
            // Si no tiene fecha y no est√° terminada, la mandamos a Prioridad Baja
            prioridadBaja++;
        } else {
            fecha.setHours(0, 0, 0, 0);
            const diffDias = Math.ceil((fecha - hoy) / (1000 * 60 * 60 * 24));

            if (diffDias < 0) {
                vencidos++;
            } else {
                // Clasificaci√≥n de prioridad por d√≠as
                if (diffDias <= 2) {
                    prioridadAlta++;
                } else if (diffDias <= 7) {
                    prioridadMedia++;
                } else {
                    prioridadBaja++;
                }

                // Pr√≥ximos a vencer (0 a 3 d√≠as)
                if (diffDias <= 3) {
                    proximos++;
                }
            }
        }
    });

    // Actualizar los n√∫meros en la pantalla
    document.getElementById('totalTasks').textContent = total;
    document.getElementById('overdueTasks').textContent = vencidos;
    document.getElementById('upcomingTasks').textContent = proximos;
    document.getElementById('highPriorityTasks').textContent = prioridadAlta;
    document.getElementById('mediumPriorityTasks').textContent = prioridadMedia;
    document.getElementById('lowPriorityTasks').textContent = prioridadBaja;
}


    // Renderizar Tareas
    let mostrarFinalizados = false;// El tablero inicia ocultando los terminados
    function renderTasks(filteredTasks = tasks) {
      filteredTasks = filteredTasks.filter(task => {
        if (task.visible === false) return false;
        if (!mostrarFinalizados && task.state === "Finalizado" && task.progress === 100) return false;
        return true;
      });
      const taskList = document.getElementById('taskList');
      taskList.innerHTML = '';
      if (filteredTasks.length === 0) {
        taskList.innerHTML = '<p class="no-results">No se encontraron tareas con los filtros aplicados.</p>';
        return;
      }
      filteredTasks.forEach(task => {
            // L√≥gica de alerta por fecha de compromiso
      const fechaCompromiso = parseDate(task.fechaCompromisoCliente);
      let colorTitulo = '#1a1a1a'; // Color negro por defecto
      
      // NUEVO: Solo evaluar si NO est√° finalizado y NO est√° al 100%
      const estaPendiente = task.progress < 100 && task.state !== "Finalizado";

      if (fechaCompromiso && estaPendiente) {
        const hoy = new Date();
        // Normalizamos "hoy" para que la comparaci√≥n sea solo por d√≠as
        hoy.setHours(0, 0, 0, 0); 
        
        const diferenciaTiempo = fechaCompromiso - hoy;
        const diasRestantes = Math.ceil(diferenciaTiempo / (1000 * 60 * 60 * 24));

        if (diasRestantes <= 3) {
          colorTitulo = '#dc3545'; // Rojo: ¬°Cr√≠tico!
        } else if (diasRestantes <= 7) {
          colorTitulo = '#fd7e14'; // Naranja: Atenci√≥n
        }
      }
        const taskCard = document.createElement('div');
        taskCard.className = 'card task-card';
        taskCard.innerHTML = `
          <div class="card-body">
            <h5 style="color: ${colorTitulo}; font-weight: bold;">
              ${task.id} - ${task.title} 
              ${colorTitulo === '#dc3545' ? ' <i class="fas fa-exclamation-triangle"></i>' : ''}
            </h5>
            <div class="d-flex flex-wrap gap-3 mb-2" style="font-size: 0.9em; color: #555;">
            <div><strong>Persona:</strong> ${task.assigned}</div>
            <div><strong>Estado:</strong> ${task.state}</div>
            <div><strong>Avance:</strong> ${task.progress}%</div>
            <div><strong>Unidad:</strong> ${task.unit}</div>
            <div><strong>Compromiso:</strong> ${task.fechaCompromisoCliente || 'Pendiente'}</div>
            <div><strong>Producci√≥n:</strong> ${task.produccion || 'N/A'}</div>
          </div>
            <div class="progress mb-2">
              <div class="progress-bar ${task.progress === 100 ? 'bg-verde-finalizado' : 'bg-info'}"
                role="progressbar"
                style="width: ${task.progress}%;"
                aria-valuenow="${task.progress}"
                aria-valuemin="0"
                aria-valuemax="100">
                ${task.progress}%
              </div>
            </div>
            <a href="#" class="toggle-details" data-id="${task.id}">M√°s</a>

           <div id="details-${task.id}" style="display: none; border-top: 1px dashed #ccc; margin-top: 10px; padding-top: 10px;">
          
          <div class="d-flex flex-wrap gap-3 mb-3" style="font-size: 0.95em;">
          <div><strong>Fecha Inicio:</strong> ${task.startDate || 'N/A'}</div>
          <div><strong>Entrega Estimada:</strong> ${task.fechaEstimadaEntrega || 'Pendiente'}</div>
          <div><strong>D√≠as Estimados:</strong> ${task.diasEstimadosDesarrollo || 0}</div>
          <div><strong>Fecha Fin:</strong> ${task.endDate || 'Sin Finalizar'}</div>
          <div>
            <strong>D√≠as Totales:</strong> 
            <span style="color: ${task.diasTotalDesarrollo > task.diasEstimadosDesarrollo ? '#dc3545' : '#28a745'}; font-weight: bold;">
              ${task.diasTotalDesarrollo || 0}
            </span>
          </div>
        </div>

          <div class="detail-toggle">
         <a href="#" class="toggle-detail-text" data-id="${task.id}">[+] Ver Detalle Requerimiento</a>
                <div id="detail-text-${task.id}" class="detail-text" style="display: none; margin-top: 5px;">
                  <div class="detail-text">${formatearDetalle(task.detail)}</div>
                </div>
              </div>
              <p><strong>Observaciones:</strong><br>
               <pre style="white-space: pre-wrap; font-family: inherit;">${(task.observations || '').replace(/\[(.*?)\]/g, '<strong>$1</strong>')}</pre>
              </p>
            </div>
          </div>
        `;
        taskList.appendChild(taskCard);
      });
      document.querySelectorAll('.toggle-detail-text').forEach(link => {
        link.addEventListener('click', function (e) {
          e.preventDefault();
          const id = this.dataset.id;
          const detailDiv = document.getElementById(`detail-text-${id}`);
          const isVisible = detailDiv.style.display === 'block';
          detailDiv.style.display = isVisible ? 'none' : 'block';
          this.textContent = isVisible ? '[+] Ver Detalle Requerimiento' : '[-] Ocultar Detalle Requerimiento';
        });
      });
      document.querySelectorAll('.toggle-details').forEach(button => {
        button.addEventListener('click', e => {
          e.preventDefault();
          const taskId = e.target.getAttribute('data-id');
          const details = document.getElementById(`details-${taskId}`);
          if (details.style.display === 'none') {
            details.style.display = 'block';
            e.target.textContent = 'Menos';
          } else {
            details.style.display = 'none';
            e.target.textContent = 'M√°s';
          }
        });
      });
    }

    // Renderizar Estad√≠sticas
    function updateStatistics(filteredTasks = tasks) {
      filteredTasks = filteredTasks.filter(task => {
        if (task.visible === false) return false;
        if (!mostrarFinalizados && task.state === "Finalizado" && task.progress === 100) return false;
        return true;
      });
      const estadisticasContent = document.getElementById('estadisticasContent');
      estadisticasContent.innerHTML = '';
      if (filteredTasks.length === 0) {
        estadisticasContent.innerHTML = '<p class="no-results"><i class="fas fa-exclamation-circle me-2"></i>No hay datos para estad√≠sticas con los filtros aplicados.</p>';
        return;
      }
      const statesCount = filteredTasks.reduce((acc, task) => {
        acc[task.state] = (acc[task.state] || 0) + 1;
        return acc;
      }, {});
      let statesHtml = '<h5>Tareas por Estado:</h5><ul>';
      for (const state in statesCount) {
        statesHtml += `<li><strong>${state}:</strong> ${statesCount[state]}</li>`;
      }
      statesHtml += '</ul>';
      const assignedCount = filteredTasks.reduce((acc, task) => {
        const assignedName = task.assigned ? task.assigned.split(' ').map(namePart => namePart.charAt(0).toUpperCase() + namePart.slice(1).toLowerCase()).join(' ') : 'Sin Asignar';
        acc[assignedName] = (acc[assignedName] || 0) + 1;
        return acc;
      }, {});
      let assignedHtml = '<h5>Tareas por Persona Asignada:</h5><ul>';
      for (const assigned in assignedCount) {
        assignedHtml += `<li><strong>${assigned}:</strong> ${assignedCount[assigned]}</li>`;
      }
      assignedHtml += '</ul>';      estadisticasContent.innerHTML = statesHtml + assignedHtml + '<hr><div id="lastUpdateByUnitContainer"></div>';
    }

    // --------------------------------------------------
    // √öltima actualizaci√≥n por unidad
    // --------------------------------------------------
    // Extrae fechas entre corchetes [dd/mm/yyyy] dentro de un texto
    function extractDatesFromText(text) {
      if (!text || typeof text !== 'string') return [];
      const regex = /\[(\d{1,2}\/\d{1,2}\/\d{4})\]/g;
      const matches = [];
      let m;
      while ((m = regex.exec(text)) !== null) {
        matches.push(m[1]);
      }
      return matches;
    }

    // Calcula y muestra la √∫ltima fecha por unidad y tareas asociadas
    function updateLastUpdatePerUnit(filteredTasks = tasks) {
      const container = document.getElementById('lastUpdateByUnitContainer');
      if (!container) return;
      container.innerHTML = '';

      const byUnit = {};

      filteredTasks.forEach(task => {
        if (task.visible === false) return;
        const unit = task.unit || 'Sin Unidad';

        // Recolectar posibles fechas de la tarea
        const candidates = [];
        if (task.startDate) candidates.push(task.startDate);
        if (task.endDate) candidates.push(task.endDate);
        let lastObservationText = null;
let lastObservationDate = null;

if (task.observations && typeof task.observations === 'string') {
  const regex = /\[(\d{1,2}\/\d{1,2}\/\d{4})\]([\s\S]*?)(?=\[\d{1,2}\/\d{1,2}\/\d{4}\]|$)/g;
  let match;

  while ((match = regex.exec(task.observations)) !== null) {
    const dateStr = match[1];
    const text = match[2].trim();

    const parsedDate = parseDate(dateStr);
    if (!parsedDate) continue;

    candidates.push(dateStr);

    if (!lastObservationDate || parsedDate > lastObservationDate) {
      lastObservationDate = parsedDate;
      lastObservationText = text;
    }
  }
}

        // Parsear y mantener fechas v√°lidas
        const parsed = candidates
          .map(d => parseDate(d))
          .filter(d => d && !isNaN(d.getTime()));

        if (parsed.length === 0) return;

        const maxDate = parsed.reduce((a, b) => (a > b ? a : b));

        if (!byUnit[unit] || byUnit[unit].date < maxDate) {
          byUnit[unit] = { date: maxDate, tasks: [{ id: task.id, title: task.title, state: task.state, progress: task.progress, lastObservation: lastObservationText }] };
        } else if (byUnit[unit].date.getTime() === maxDate.getTime()) {
          byUnit[unit].tasks.push({ id: task.id, title: task.title, state: task.state, progress: task.progress, lastObservation: lastObservationText });
        }
      });

      // Construir tabla HTML
      const rows = Object.keys(byUnit).sort().map(unit => {
        const info = byUnit[unit];
        const date = info.date;
        const dateStr = date ? `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}` : '-';
        const MAX_LEN = 120;
 // 1Ô∏è‚É£ PRIMER BLOQUE
  const rowsByTask = info.tasks.map(t => {
  const safeId = t.id.replace(/[^a-zA-Z0-9_-]/g, '');
  const hasObs = !!t.lastObservation;

  const fullText = hasObs ? t.lastObservation.trim() : '';
  const isLong = fullText.length > MAX_LEN;
  const shortText = isLong ? fullText.slice(0, MAX_LEN) + '...' : fullText;

  return `
    <tr>
      <td style="vertical-align:top; padding:4px 6px;">
        <strong>${t.id}</strong> - ${t.title}
        (${t.state}, ${t.progress}%)
      </td>
      <td style="vertical-align:top; padding:4px 6px; word-wrap:break-word; white-space:normal;">
        ${hasObs
          ? `
            <span id="obs-short-${safeId}">${shortText}</span>
            <span id="obs-full-${safeId}" style="display:none;">${fullText}</span>
            ${isLong
              ? `<a href="#"
                   data-id="${safeId}"
                   class="toggle-obs"
                   style="margin-left:6px; font-size:0.85em;">
                   ver m√°s
                 </a>`
              : ''}
          `
          : '-'}
      </td>
    </tr>
  `;
}).join('');


  // 3Ô∏è‚É£ RETORNO FINAL
 return `
  <tr>
    <td style="vertical-align:top;">${unit}</td>
    <td style="vertical-align:top;">${dateStr}</td>
    <td colspan="2" style="vertical-align:top;">
      <table style="width:100%; border-collapse:collapse; text-align:left; table-layout:fixed;">
        ${rowsByTask}
      </table>
    </td>
  </tr>
`;

}).join('');
      const html = `
        <button id="export-last-update" class="btn btn-sm btn-secondary mb-2">Exportar CSV</button>
        <div class="table-responsive">
          <table class="table table-sm" style="table-layout:fixed; width:100%;">
           <thead>
             <tr>
             <th style="width:05%;">Unidad</th>
             <th style="width:10%;">√öltima Actualizaci√≥n</th>
             <th style="width:30%;">Tareas (ID - T√≠tulo - Estado - %)</th>
             <th style="width:40%; text-align:center;">√öltima observaci√≥n</th>
            </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;

      container.innerHTML = html;
      container.querySelectorAll('.toggle-obs').forEach(link => {
  link.addEventListener('click', e => {
    e.preventDefault();

    const id = link.dataset.id;
    const shortEl = document.getElementById(`obs-short-${id}`);
    const fullEl = document.getElementById(`obs-full-${id}`);

    if (!shortEl || !fullEl) return;

    const expanded = fullEl.style.display === 'inline';
    fullEl.style.display = expanded ? 'none' : 'inline';
    shortEl.style.display = expanded ? 'inline' : 'none';
    link.textContent = expanded ? 'ver m√°s' : 'ver menos';
  });
});


      // A√±adir evento para exportar CSV
      document.getElementById('export-last-update').addEventListener('click', () => {
        const data = Object.keys(byUnit).map(u => ({ unit: u, date: byUnit[u].date, tasks: byUnit[u].tasks }));
        exportLastUpdateCSV(data);
      });
    }

    // Exportar CSV
    function exportLastUpdateCSV(data) {
  const SEP = ','; // separador CSV
  const lines = [
    `Unidad${SEP}√öltima Actualizaci√≥n${SEP}Requerimiento${SEP}Estado${SEP}Progreso${SEP}√öltima observaci√≥n`
  ];

  data.forEach(row => {
    const d = row.date;
    const dateStr = d
      ? `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`
      : '';

    row.tasks.forEach(t => {
      const obs = (t.lastObservation || '')
  .replace(/(\r\n|\n|\r)/g, ' ')   // elimina TODOS los saltos de l√≠nea
  .replace(/\s+/g, ' ')           // colapsa espacios m√∫ltiples
  .replace(/"/g, '""')            // escapa comillas
  .trim();

      const title = (t.title || '')
  .replace(/(\r\n|\n|\r)/g, ' ')
  .replace(/\s+/g, ' ')
  .replace(/"/g, '""')
  .trim();

      const state = (t.state || '').replace(/"/g, '""');

      lines.push(
        `"${row.unit}"${SEP}` +
        `"${dateStr}"${SEP}` +
        `"${t.id} - ${title}"${SEP}` +
        `"${state}"${SEP}` +
        `"${t.progress}%"${SEP}` +
        `"${obs}"`
      );
    });
  });

  // BOM UTF-8 para Excel
  const csvContent = '\uFEFF' + lines.join('\n');
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `Ultima_Actualizacion_Por_Unidad_${formattedDate}.csv`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

    // Normaliza estados: quita acentos, pone min√∫sculas, colapsa espacios
function normalizarEstado(estado) {
  return (estado ?? '')
    .normalize('NFD')                       // separa letras y acentos
    .replace(/[\u0300-\u036f]/g, '')        // quita los acentos
    .toLowerCase()                          // pasa todo a min√∫sculas
    .replace(/\s+/g, ' ')                   // colapsa espacios m√∫ltiples
    .trim();                                // elimina espacios iniciales/finales
}

    // Gr√°ficos

// Gr√°fico de distribuci√≥n de estados
function plotPieChart(filteredTasks = tasks) {
  const pieDiv = document.getElementById('pie-chart');
  document.getElementById('loadingPie').style.display = 'block';
  pieDiv.style.display = 'none';

  if (filteredTasks.length === 0) {
    Plotly.newPlot(pieDiv, [], {}, { displayModeBar: false });
    pieDiv.innerHTML = '<p class="no-results mt-4"><i class="fas fa-exclamation-circle me-2"></i>No hay datos para el gr√°fico de estados.</p>';
    document.getElementById('loadingPie').style.display = 'none';
    pieDiv.style.display = 'block';
    return;
  }

  // Filtrar tareas invisibles
const visibleTasks = filteredTasks.filter(task => task.visible !== false);

const stateCounts = visibleTasks.reduce((acc, task) => {
  acc[task.state] = (acc[task.state] || 0) + 1;
  return acc;
}, {});

  const data = [{
    labels: Object.keys(stateCounts),
    values: Object.values(stateCounts),
    type: 'pie',
    textinfo: 'label+percent',
    insidetextorientation: 'radial'
  }];

  const layout = {
    title: 'Distribuci√≥n de Estados',
    height: 500,
    margin: { t: 80, b: 50, l: 50, r: 50 }
  };

  Plotly.newPlot(pieDiv, data, layout, { responsive: true, displayModeBar: false });
  document.getElementById('loadingPie').style.display = 'none';
  pieDiv.style.display = 'block';
}

// Gr√°fico de avance de tareas
function plotBarChart(filteredTasks = tasks) {
  filteredTasks = filteredTasks.filter(task => {
    if (task.visible === false) return false;
    if (!mostrarFinalizados && task.state === "Finalizado" && task.progress === 100) return false;
    return true;
  });

  document.getElementById('loadingBar').style.display = 'block';
  const barChartDiv = document.getElementById('bar-chart');
  barChartDiv.style.display = 'none';

  if (filteredTasks.length === 0) {
    Plotly.newPlot(barChartDiv, [], {}, { displayModeBar: false });
    barChartDiv.innerHTML = '<p class="no-results mt-4"><i class="fas fa-exclamation-circle me-2"></i>No hay datos para el gr√°fico de avance.</p>';
    document.getElementById('loadingBar').style.display = 'none';
    barChartDiv.style.display = 'block';
    return;
  }

  const estadosEnCurso = [
    "En Proceso",
    "Entrenamiento",
    "Pruebas Imagine",
    "Paso A Produccion",
    "En Test",
    "Pruebas Cliente"
  ];
  console.log("DEBUG estadosEnCurso normalizados:", estadosEnCurso.map(e => normalizarEstado(e)));
filteredTasks.forEach(t => {
  console.log(
    `Task ID ${t.id} => state original: "${t.state}", normalizado: "${normalizarEstado(t.state)}", progress: ${t.progress}`
  );

});

  const inProgressTasks = filteredTasks.filter(task =>
    estadosEnCurso.map(e => normalizarEstado(e)).includes(normalizarEstado(task.state)) &&
    Number(task.progress) > 0
  );
console.log("DEBUG inProgressTasks (los que van al gr√°fico):", inProgressTasks);
  if (inProgressTasks.length === 0) {
    Plotly.newPlot(barChartDiv, [], {}, { displayModeBar: false });
    barChartDiv.innerHTML = '<p class="no-results mt-4"><i class="fas fa-info-circle me-2"></i>No hay tareas en curso con avance mayor a 0%.</p>';
    document.getElementById('loadingBar').style.display = 'none';
    barChartDiv.style.display = 'block';
    return;
  }

  const ids       = inProgressTasks.map(t => t.id);
  const progresses= inProgressTasks.map(t => Number(t.progress));
  const titles    = inProgressTasks.map(t => t.title);
  const states    = inProgressTasks.map(t => t.state);
  const estadosPresentes = [...new Set(states)];

  const data = [{
  x: inProgressTasks.map(t => t.id),
  y: progresses,
  type: 'bar',
  name: 'Avance',
  marker: { color: '#1f77b4' },
  hoverinfo: 'text',
  text: inProgressTasks.map((t, i) =>
    `<b>ID:</b> ${t.id}<br><b>T√≠tulo:</b> ${t.title}<br><b>Estado:</b> ${t.state}<br><b>Avance:</b> ${progresses[i]}%`
  ),
}];

  const layout = {
    title: `Avance de Tareas<br><sub>Mostrando: ${estadosPresentes.join(', ')}</sub>`,
    xaxis: { title: 'ID de Tarea', tickangle: -45, automargin: true },
    yaxis: { title: '% Avance', range: [0, 100] },
    height: 500,
    margin: { t: 90, b: 150, l: 50, r: 50 },
    hovermode: 'closest'
  };

  Plotly.newPlot(barChartDiv, data, layout, { responsive: true, displayModeBar: false });
  document.getElementById('loadingBar').style.display = 'none';
  barChartDiv.style.display = 'block';
}

// Gr√°fico de tareas por persona asignada
function plotAssignmentsChart(filteredTasks = tasks) {
  filteredTasks = filteredTasks.filter(task => {
    if (task.visible === false) return false;
    if (!mostrarFinalizados && task.state === "Finalizado" && task.progress === 100) return false;

    const estadosEnCurso = [
      "En Proceso",
      "Entrenamiento",
      "Pruebas Imagine",
      "Paso A Produccion",
      "En Test",
      "Pruebas Cliente"
    ];

return estadosEnCurso.map(e => normalizarEstado(e)).includes(normalizarEstado(task.state))

  });

  document.getElementById('loadingAssignments').style.display = 'block';
  const assignmentsChartDiv = document.getElementById('assignments-chart');
  assignmentsChartDiv.style.display = 'none';

  if (filteredTasks.length === 0) {
    Plotly.newPlot(assignmentsChartDiv, [], {}, { displayModeBar: false });
    assignmentsChartDiv.innerHTML = '<p class="no-results mt-4"><i class="fas fa-exclamation-circle me-2"></i>No hay datos para el gr√°fico de asignaciones.</p>';
    document.getElementById('loadingAssignments').style.display = 'none';
    assignmentsChartDiv.style.display = 'block';
    return;
  }

  const assignedCounts = filteredTasks.reduce((acc, task) => {
    const assignedName = task.assigned
      ? task.assigned.split(' ')
          .map(part => part.charAt(0).toUpperCase() + part.slice(1).toLowerCase())
          .join(' ')
      : 'Sin Asignar';
    acc[assignedName] = (acc[assignedName] || 0) + 1;
    return acc;
  }, {});

  const data = [{
    x: Object.keys(assignedCounts),
    y: Object.values(assignedCounts),
    type: 'bar',
    name: 'N√∫mero de Tareas Asignadas',
    marker: { color: '#2ca02c' }
  }];

  const layout = {
    title: 'N√∫mero de Tareas por Persona Asignada',
    xaxis: { title: 'Persona Asignada', tickangle: -45, automargin: true },
    yaxis: { title: 'N√∫mero de Tareas' },
    height: 500,
    margin: { t: 80, b: 150, l: 50, r: 50 }
  };

  Plotly.newPlot(assignmentsChartDiv, data, layout, { responsive: true, displayModeBar: false });
  document.getElementById('loadingAssignments').style.display = 'none';
  assignmentsChartDiv.style.display = 'block';
}
        // L√≥gica de Filtrado
    function applyFilters() {
    const estado = document.getElementById('estadoFiltro').value;
    const unidad = document.getElementById('unidadFiltro').value;
    const busqueda = document.getElementById('busqueda').value.toLowerCase();
    const idFiltro = document.getElementById('idFiltro').value.toLowerCase();
    const fechaInicio = document.getElementById('fechaInicioFiltro').value;
    const fechaFin = document.getElementById('fechaFinFiltro').value;

    // üÜï NUEVO: Activar autom√°ticamente el bot√≥n si se filtra por "Finalizado" o por ID espec√≠fico
  const btnFinalizados = document.getElementById('toggleFinalizados');
  if ((estadoFiltro === "Finalizado" || idFiltro !== '') && !mostrarFinalizados) {
      mostrarFinalizados = true;
      btnFinalizados.textContent = "Ocultar Finalizados";
      btnFinalizados.classList.add('modo-activo');
  }

    let tareasFiltradas = tasks.filter(task => {
        // Filtro de Visibilidad (General)
        if (task.visible === false) return false;

        // Filtro de Estado y Unidad
        const cumpleEstado = estado === "" || task.state === estado;
        const cumpleUnidad = unidad === "" || task.unit === unidad;
        
        // Filtro de Texto (ID, T√≠tulo o Asignado)
        const cumpleTexto = task.title.toLowerCase().includes(busqueda) || 
                            task.assigned.toLowerCase().includes(busqueda);
        const cumpleID = task.id.toString().toLowerCase().includes(idFiltro);

        // Filtro por Fechas
       let cumpleFecha = true;

        if (fechaInicio) {
            const fechaInicioTarea = parseDate(task.startDate);
            if (!fechaInicioTarea || fechaInicioTarea < new Date(fechaInicio)) {
                cumpleFecha = false;
            }
        }

        if (fechaFin) {
            const fechaFinTarea = parseDate(task.endDate);
            // Si hay filtro de fecha fin, la tarea DEBE tener endDate y estar dentro del rango
            if (!fechaFinTarea || fechaFinTarea > new Date(fechaFin)) {
                cumpleFecha = false;
            }
        }

        // --- L√ìGICA DE FILTRO POR TARJETAS DEL DASHBOARD ---
        let cumpleDashboard = true;
        if (filtroDashboard) {
            const hoy = new Date(); hoy.setHours(0,0,0,0);
            const fechaControl = parseDate(task.fechaCompromisoCliente || task.fechaEstimadaEntrega);
            const diffDias = fechaControl ? Math.ceil((fechaControl - hoy) / (1000 * 60 * 60 * 24)) : null;

            if (filtroDashboard === 'vencido') cumpleDashboard = (task.progress < 100 && diffDias !== null && diffDias < 0);
            if (filtroDashboard === 'proximo') cumpleDashboard = (task.progress < 100 && diffDias !== null && diffDias >= 0 && diffDias <= 3);
            if (filtroDashboard === 'alta') cumpleDashboard = (task.progress < 100 && diffDias !== null && diffDias >= 0 && diffDias <= 2);
            if (filtroDashboard === 'media') cumpleDashboard = (task.progress < 100 && diffDias !== null && diffDias > 2 && diffDias <= 7);
            if (filtroDashboard === 'baja') cumpleDashboard = (task.progress < 100 && (diffDias === null || diffDias > 7));
        }

        return cumpleEstado && cumpleUnidad && cumpleTexto && cumpleID && cumpleFecha && cumpleDashboard;
    });

    // Actualizar todos los componentes con los datos filtrados
    renderTasks(tareasFiltradas);
    updateSummary(tareasFiltradas);
    updateDashboard(tasks); // El dashboard siempre muestra el conteo global o seg√∫n filtros de arriba
    updateStatistics(tareasFiltradas);
    
    // Actualizar gr√°ficos (solo si las funciones existen)
    if (typeof plotPieChart === 'function') plotPieChart(tareasFiltradas);
    if (typeof plotBarChart === 'function') plotBarChart(tareasFiltradas);
    if (typeof plotAssignmentsChart === 'function') plotAssignmentsChart(tareasFiltradas);
    if (typeof updateLastUpdatePerUnit === 'function') updateLastUpdatePerUnit(tareasFiltradas);
}


    // Exportaci√≥n a PDF
    function exportToPDF() {
      const unsavedText = document.getElementById('observaciones-input').value.trim();
      if (unsavedText !== '') {
        if (!confirm('Hay observaciones no guardadas. ¬øDeseas continuar con la exportaci√≥n?')) {
          return;
        }
      }
      const element = document.querySelector('.content');
      const opt = {
        margin: 0.5,
        filename: `Reporte_Requerimientos_${formattedDate}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      };
      const loadingOverlay = document.createElement('div');
      loadingOverlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; justify-content: center; align-items: center; color: #1f77b4; font-size: 2em;';
      loadingOverlay.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generando PDF...';
      document.body.appendChild(loadingOverlay);
      document.querySelector('.sidebar').style.display = 'none';
      document.querySelector('.content').style.marginLeft = '0';
      html2pdf().set(opt).from(element).save().then(() => {
        document.body.removeChild(loadingOverlay);
        document.querySelector('.sidebar').style.display = 'block';
        document.querySelector('.content').style.marginLeft = '270px';
        initializeReport();
        applyFilters();
      }).catch(error => {
        console.error('Error generating PDF:', error);
        document.body.removeChild(loadingOverlay);
        document.querySelector('.sidebar').style.display = 'block';
        document.querySelector('.content').style.marginLeft = '270px';
        alert('Error al generar el PDF. Por favor, intenta de nuevo.');
      });
    }

    // Exportaci√≥n a PNG
    async function exportToPNG() {
      document.querySelector('.sidebar').style.display = 'none';
      document.querySelector('.content').style.marginLeft = '0';
      const originalGraphsHtml = document.getElementById('graficos').innerHTML;
      document.getElementById('graficos').innerHTML = '<div style="text-align: center; padding: 50px; font-size: 2em; color: #1f77b4;"><i class="fas fa-spinner fa-spin me-2"></i>Generando im√°genes de gr√°ficos...</div>';
      const chartsToExport = ['pie-chart', 'bar-chart', 'assignments-chart'];
      const zip = new JSZip();
      for (const chartId of chartsToExport) {
        const plotDiv = document.getElementById(chartId);
        if (plotDiv && plotDiv.innerHTML.includes('<svg')) {
          try {
            const imageData = await Plotly.toImage(plotDiv, { format: 'png', height: 600, width: 800 });
            const base64Data = imageData.split(',')[1];
            zip.file(`${chartId}.png`, base64Data, { base64: true });
          } catch (error) {
            console.error(`Error al exportar el gr√°fico ${chartId}:`, error);
          }
        } else {
          console.warn(`El div ${chartId} no contiene un gr√°fico Plotly o est√° vac√≠o, se omitir√° la exportaci√≥n.`);
        }
      }
      zip.generateAsync({ type: "blob" })
        .then(function(content) {
          const link = document.createElement('a');
          link.href = URL.createObjectURL(content);
          link.download = `Graficos_Requerimientos_${formattedDate}.zip`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(link.href);
        })
        .finally(() => {
          document.getElementById('graficos').innerHTML = originalGraphsHtml;
          document.querySelector('.sidebar').style.display = 'block';
          document.querySelector('.content').style.marginLeft = '270px';
          plotPieChart(tasks);
          plotBarChart(tasks);
          plotAssignmentsChart(tasks);
        });
    }

    // Inicializar el reporte
   function initializeReport() {
    populateEstadoFilter(tasks);
    populateUnidadFilter(tasks); // ¬°Importante!
    
    // Eventos de Filtros
    document.getElementById('estadoFiltro').addEventListener('change', applyFilters);
    document.getElementById('unidadFiltro').addEventListener('change', applyFilters);
    document.getElementById('fechaInicioFiltro').addEventListener('change', applyFilters);
    document.getElementById('fechaFinFiltro').addEventListener('change', applyFilters);
    document.getElementById('busqueda').addEventListener('input', applyFilters);
    document.getElementById('idFiltro').addEventListener('input', applyFilters);

    // Bot√≥n Limpiar
    document.getElementById('btnLimpiarFiltros').addEventListener('click', () => {
        document.getElementById('estadoFiltro').value = '';
        document.getElementById('unidadFiltro').value = '';
        document.getElementById('fechaInicioFiltro').value = '';
        document.getElementById('fechaFinFiltro').value = '';
        document.getElementById('idFiltro').value = '';
        document.getElementById('busqueda').value = '';
        filtroDashboard = null; 
        document.querySelectorAll('.dashboard-cards .card').forEach(t => t.classList.remove('card-activa'));
        applyFilters();
    });

    // Bot√≥n Mostrar Finalizados
    document.getElementById('toggleFinalizados').addEventListener('click', function() {
        mostrarFinalizados = !mostrarFinalizados;
        this.classList.toggle('modo-activo');
        this.textContent = mostrarFinalizados ? "Ocultar Finalizados" : "Mostrar Finalizados";
        applyFilters();
        
    });

    // LLAMADA INICIAL PARA CARGAR TODO
    applyFilters(); 
}

    // Formatear detalle
    function formatearDetalle(texto) {
      if (!texto) return 'Sin detalle registrado.';
      return texto
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/^- (.*)$/gm, '<li>$1</li>')
        .replace(/(<li>.*<\/li>)/g, '<ul>$1</ul>');
    }


    // Funci√≥n para enviar observaciones al Google Form
    function submitObservation() {
  const observacion = document.getElementById("observaciones-input").value.trim();
  const nombre = document.getElementById("nombre-observador").value.trim();

  // Validar que ambos campos est√©n llenos
  if (!nombre) {
    alert("Por favor, escribe tu nombre.");
    return;
  }

  if (!observacion) {
    alert("Por favor, escribe una observaci√≥n.");
    return;
  }

  const formData = new FormData();
  formData.append("entry.417936999", observacion);      // Campo Observaci√≥n
  formData.append("entry.1842471098", nombre);          // Campo Nombre

  fetch("https://docs.google.com/forms/d/e/1FAIpQLSckJu7_1OG8F0PrX1M6JfcldPQdAWPYlOQOZlzQpd9fdTcsqA/formResponse", {
    method: "POST",
    mode: "no-cors",
    body: formData
  }).then(() => {
    document.getElementById("observaciones-input").value = "";
    document.getElementById("nombre-observador").value = "";
    alert("Observaci√≥n guardada con √©xito.");
    loadObservations();
  }).catch(error => {
    console.error("Error al enviar la observaci√≥n:", error);
    alert("Ocurri√≥ un error al guardar la observaci√≥n.");
  });
}
// Funci√≥n para cargar observaciones (se implementar√° en el pr√≥ximo paso)
function loadObservations() {
  const url = 'https://opensheet.elk.sh/1tifWNA450_RR83JM2TmI2q4RUyGLzNKAOsXy_sHJRFo/Form Responses 1';

  fetch(url)
    .then(response => response.json())
    .then(data => {
      const contenedor = document.getElementById('saved-observations');
// ‚õî CONTENEDOR NO EXISTE ‚Üí salir sin error
  if (!contenedor) {
    console.warn('saved-observations no existe en el DOM, se omite carga.');
    return;
  }
 if (!data || data.length === 0) {
    contenedor.innerHTML = '<p class="no-results">A√∫n no hay observaciones registradas.</p>';
    return;
  }
      contenedor.innerHTML = '';
      data.reverse().forEach(obs => {
        const texto = obs["Escribe tu observaci√≥n"] || "";
        const nombreKey = Object.keys(obs).find(k => k.toLowerCase().includes("nombre"));
        const nombre = nombreKey ? obs[nombreKey] : "An√≥nimo";
        const timestamp = obs["Marca temporal"] || "";

        // Si la observaci√≥n est√° vac√≠a, no mostrar nada
        if (!texto || texto.trim() === "") return;

        const p = document.createElement('p');
        p.innerHTML = `<strong>${nombre}</strong> (${timestamp}): ${texto}`;
        contenedor.appendChild(p);
      });
    })
    .catch(error => {
      console.error('Error al cargar observaciones:', error);
      document.getElementById('saved-observations').innerHTML = '<p class="no-results">Error al cargar observaciones.</p>';
    });
}

      function activarFiltroDashboard(tipo) {
    filtroDashboard = (filtroDashboard === tipo) ? null : tipo;

    // 1. Quitamos el efecto a todas las tarjetas
    document.querySelectorAll('.dashboard-cards .card').forEach(card => {
        card.classList.remove('card-activa');
    });

    // 2. Si el filtro est√° activo, buscamos la tarjeta y le ponemos el efecto
    if (filtroDashboard) {
        // Buscamos la tarjeta que tenga la clase que coincide con el tipo (vencido, alta, etc.)
        const tarjetaElegida = document.querySelector(`.dashboard-cards .card.${tipo}`);
        if (tarjetaElegida) {
            tarjetaElegida.classList.add('card-activa');
        }
    }

    applyFilters();
}

// Cargar observaciones al iniciar la p√°gina
document.addEventListener('DOMContentLoaded', loadObservations);
  </script>
  <script>
document.addEventListener("DOMContentLoaded", function () {

    const tasks = document.querySelectorAll(".task-card");

    let total = tasks.length;
    let highPriority = 0;
    let overdue = 0;
    let upcoming = 0;

    const today = new Date();

    tasks.forEach(task => {

        const priorityText = task.innerText;
        const dateElement = task.querySelector(".date-status");

        // Contar prioridad alta
        if (priorityText.includes("Alta")) {
            highPriority++;
        }

        if (dateElement) {
            const dateText = dateElement.innerText;
            const dateMatch = dateText.match(/\d{4}-\d{2}-\d{2}/);

            if (dateMatch) {
                const dueDate = new Date(dateMatch[0]);

                const diffTime = dueDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays < 0) {
                    overdue++;
                } else if (diffDays <= 3) {
                    upcoming++;
                }
            }
        }

    });

    document.getElementById("totalTasks").innerText = total;
    document.getElementById("highPriorityTasks").innerText = highPriority;
    document.getElementById("overdueTasks").innerText = overdue;
    document.getElementById("upcomingTasks").innerText = upcoming;
        // Escuchar cambios en los nuevos filtros
    document.getElementById('fechaInicioFiltro').addEventListener('change', applyFilters);
    document.getElementById('fechaFinFiltro').addEventListener('change', applyFilters);
    document.getElementById('idFiltro').addEventListener('input', applyFilters);
    document.getElementById('estadoFiltro').addEventListener('change', applyFilters);
    document.getElementById('unidadFiltro').addEventListener('change', applyFilters);
    document.getElementById('busqueda').addEventListener('input', applyFilters);

    // Configurar el bot√≥n Limpiar
    document.getElementById('btnLimpiarFiltros').addEventListener('click', () => {
        document.getElementById('estadoFiltro').value = 'Todos';
        document.getElementById('unidadFiltro').value = '';
        document.getElementById('fechaInicioFiltro').value = '';
        document.getElementById('fechaFinFiltro').value = '';
        document.getElementById('idFiltro').value = '';
        document.getElementById('busqueda').value = '';
        applyFilters();
});

});
</script>

</body>
</html>
